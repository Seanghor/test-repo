<!DOCTYPE html>
<html lang="km">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;600;700;800;900&display=swap"
        rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.8.0/fonts/remixicon.css" rel="stylesheet" />

    <title>Chlat Kids Sudoku (Levels + Daily)</title>
    <style>
        :root {
            --bg: #e9f6ff;
            --ink: #0b2239;
            --muted: #4b647a;
            --brand: #1a8cff;
            --brand2: #31c48d;
            --warn: #ffb020;
            --shadow: 0 14px 30px rgba(10, 30, 60, 0.12);
            --radius: 18px;
            --gap: 8px;
            --font: "Noto Sans Khmer", system-ui, -apple-system, Segoe UI, Roboto,
                Arial, sans-serif;
            --cell: 56px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: var(--font);
            color: var(--ink);
            background: radial-gradient(1200px 600px at 20% 0%,
                    rgba(26, 140, 255, 0.18),
                    transparent 60%),
                radial-gradient(900px 500px at 90% 10%,
                    rgba(49, 196, 141, 0.16),
                    transparent 60%),
                var(--bg);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .wrap {
            width: min(1100px, 100%);
            padding: 16px 14px 22px;
        }

        header {
            display: flex;
            align-items: end;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        @media (max-width: 520px) {
            header {
                align-items: start;
                flex-direction: column;
            }
        }

        .brand {
            display: flex;
            justify-content: start;
            align-items: center;
            gap: 12px;
            user-select: none;
        }

        .headerButtons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* 
        .logo {
            width: 46px;
            height: 46px;
            border-radius: 16px;
            min-width: 32px;
            min-height: 32px;
            background: linear-gradient(145deg,
                    rgba(26, 140, 255, 0.25),
                    rgba(49, 196, 141, 0.2));
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 22px rgba(10, 30, 60, 0.1);
            display: grid;
            place-items: center;
        } */

        /* .title {
            line-height: 1.1;
        } */

        .title h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: 0.2px;
        }

        .title p {
            margin: 4px 0 0;
            color: var(--muted);
            font-size: 13px;
        }

        .top-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        button,
        select {
            font-family: var(--font);
        }

        button {
            border: 0;
            /* border-radius: 10px; */
            padding: 10px 10px;
            background: #fff;
            color: var(--ink);
            border: 1px solid rgba(20, 60, 110, 0.08);
            cursor: pointer;
            transition: transform 0.08s ease, box-shadow 0.18s ease;
            touch-action: manipulation;
        }

        button:active {
            transform: translateY(1px) scale(0.99);
            box-shadow: 0 6px 12px rgba(10, 30, 60, 0.1);
        }


        button.pause {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            text-shadow:
                0.5px 0 currentColor,
                -0.5px 0 currentColor;
            background: #fab907;
            color: #000000;
            border: 0;
        }

        .actionPause {
            color: #fab907;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        button.new {
            display: flex;
            align-items: center;
            font-size: 24px;
            text-shadow:
                0.5px 0 currentColor,
                -0.5px 0 currentColor;
            background: #02e002;
            color: #000000;
            border: 0;
        }

        .actionNew {
            color: #02e002;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }


        button.primary {
            background: linear-gradient(135deg, var(--brand), #4fb3ff);
            color: #fff;
            border: 0;
        }

        button.success {
            background: linear-gradient(135deg, var(--brand2), #61e2b7);
            color: #08301f;
            border: 0;
            font-weight: 800;
            display: flex;
            justify-content: center;
            gap: 4px;
            max-height: 32px;
            align-items: center;
        }

        button.warn {
            background: linear-gradient(135deg, #ffd37a, #ffb020);
            color: #4a2b00;
            border: 0;
            font-weight: 800;
            display: flex;
            justify-content: center;
            gap: 4px;
            max-height: 32px;
            align-items: center;
        }

        button.ghost {
            display: flex;
            justify-content: center;
            gap: 4px;
            max-height: 32px;
            align-items: center;
            background: transparent;
            box-shadow: none;
            border: 1px dashed rgba(11, 34, 57, 0.25);
            color: var(--muted);
        }

        button.pillbtn {
            border-radius: 999px;
            padding: 6px 12px;
            box-shadow: none;
            border: 1px solid rgba(11, 34, 57, 0.1);
            background: rgba(255, 255, 255, 0.8);
            font-weight: 800;
            color: var(--muted);
            display: flex;
            justify-content: center;
            gap: 4px;
            min-height: 42px;
            align-items: center;
        }

        button.pillbtn.active {
            background: #fff;
            color: var(--ink);
            box-shadow: 0 10px 18px rgba(10, 30, 60, 0.1);
        }

        .btn-hint-container{
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: fit-content;
            gap: 4px;
        }
        .btn-hint-container>button{
            width: fit-content;
            border-radius: 7px;
            font-weight: 400;
            max-height: 36px;
        }
        .btn-hint-container>button>i{
            font-size: 20px;
        }

        .divider-line::after {
            content: "";
            position: absolute;
            width: 2px;
            height: var(--line-h);
            background: #000000;
            right: -8px;
            top: -14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 940px) {
            .grid {
                /* grid-template-columns: 1.15fr 0.85fr; */
                align-items: start;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.65);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 14px;
        }

        .hud {
            width: 100%;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .pill {
            background: rgba(26, 140, 255, 0.08);
            color: #094f8f;
            border: 1px solid rgba(26, 140, 255, 0.18);
            border-radius: 999px;
            padding: 4px 12px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            min-height: 42px;
        }

        .pill strong {
            font-size: 14px;
        }

        .board-wrap {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .board {
            width: fit-content;
            /* padding: 12px; */
            border-radius: 22px;
            /* background: linear-gradient(180deg,
                    rgba(255, 255, 255, 0.95),
                    rgba(255, 255, 255, 0.8)); */
            /* border: 1px solid rgba(20, 60, 110, 0.1); */
            box-shadow: 0 10px 24px rgba(10, 30, 60, 0.12);
        }

        .cells {
            display: grid;
            /* gap: var(--gap); */
            touch-action: manipulation;
        }

        .cell {
            width: var(--cell);
            height: var(--cell);
            /* border-radius: 16px; */
            border: 1px solid rgb(99, 99, 99);
            background: #fff;
            display: grid;
            place-items: center;
            font-size: 20px;
            font-weight: 900;
            cursor: pointer;
            user-select: none;
            transition: transform 0.08s ease, border-color 0.12s ease,
                background 0.12s ease;
            position: relative;
        }

        .cell:active {
            transform: scale(0.99);
        }

        .cell.given {
            background: rgba(81, 87, 85, 0.158);
            /* border-color: rgba(49, 196, 141, 0.25); */
            color: #000000;
            cursor: default;
        }

        .cell.selected {
            outline: 4px solid rgba(26, 140, 255, 0.22);
            border-color: rgba(26, 140, 255, 0.55);
            background: rgba(26, 140, 255, 0.06);
            color: rgb(57 163 255);
        }

        .cell.conflict {
            color:red;
            border-color: rgba(255, 77, 77, 0.65);
            background: rgba(255, 77, 77, 0.08);
        }

        .cell.same {
            background: rgba(26, 140, 255, 0.05);
        }

        .cell.hint {
            animation: hintPulse 0.6s ease 2;
        }

        @keyframes hintPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.03);
            }

            100% {
                transform: scale(1);
            }
        }

        .keypadBox {
            display: grid;
            align-items: center;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }

        /* LEFT */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* RIGHT (rounded container) */
        .right-panel {
            background: #ffffff;
            border-radius: 16px;
            border: 2px solid rgba(3, 90, 18, 0.1);
            /* padding: 12px; */
            /* overflow: hidden; */
            /* box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); */
        }

        /* keypad grid */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            /* üëà grid gap */
        }



        .keypad {
            /* background-color: rgb(38, 110, 245); */
            width: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            /* üëà this is what you want */
            /* gap: 10px; */
            /* background: #086df1; */
            border-radius: 10px !important;
            overflow: hidden;
        }

        .keypad button {
            padding: 14px 10px;
            font-size: 18px;
            font-weight: 900;

            /* border-radius: 0px; */
            /* border-radius: 16px; */
        }

        .keypad button.small {
            font-size: 14px;
            font-weight: 800;
            color: var(--muted);
            /* background: rgba(204, 44, 44, 0.9); */
        }

        .mini {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.45;
        }

        .right {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .frog {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .frog-face {
            width: 60px;
            height: 60px;
            border-radius: 22px;
            background: linear-gradient(145deg,
                    rgba(49, 196, 141, 0.35),
                    rgba(49, 196, 141, 0.18));
            border: 1px solid rgba(49, 196, 141, 0.35);
            box-shadow: 0 10px 20px rgba(10, 30, 60, 0.1);
            display: grid;
            place-items: center;
            flex: 0 0 auto;
        }

        .frog-face span {
            font-size: 30px;
            filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.08));
        }

        .frog-msg {
            flex: 1;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(20, 60, 110, 0.1);
            border-radius: 18px;
            padding: 12px;
            box-shadow: 0 10px 20px rgba(10, 30, 60, 0.08);
            position: relative;
        }

        .frog-msg:before {
            content: "";
            position: absolute;
            left: -7px;
            top: 18px;
            width: 14px;
            height: 14px;
            background: rgba(255, 255, 255, 0.85);
            border-left: 1px solid rgba(20, 60, 110, 0.1);
            border-bottom: 1px solid rgba(20, 60, 110, 0.1);
            transform: rotate(45deg);
        }

        .frog-msg h3 {
            margin: 0 0 6px;
            font-size: 14px;
        }

        .frog-msg p {
            margin: 0;
            font-size: 13px;
            color: var(--muted);
            line-height: 1.35;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .switch {
            display: inline-flex;
            background: rgba(11, 34, 57, 0.06);
            border: 1px solid rgba(11, 34, 57, 0.1);
            padding: 5px;
            border-radius: 999px;
            gap: 6px;
        }

        .switch button {
            box-shadow: none;
            border: 0;
            background: transparent;
            padding: 8px 10px;
            border-radius: 999px;
            font-size: 13px;
            color: var(--muted);
            font-weight: 900;
            cursor: pointer;
            justify-content: center;
            gap: 4px;
            max-height: 32px;
            align-items: center;
        }

        .switch button.active {
            background: #fff;
            color: var(--ink);
            box-shadow: 0 8px 16px rgba(10, 30, 60, 0.1);
        }

        .modeBar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            margin-top: 4px;
        }

        .lvlBox {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 10px;
            border-radius: 16px;
            background: rgba(26, 140, 255, 0.06);
            border: 1px solid rgba(26, 140, 255, 0.16);
            width: 100%;
            margin-bottom: 6px;
        }

        .lvlLeft {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .lvlLabel {
            font-weight: 900;
            color: var(--ink);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select {
            border-radius: 14px;
            padding: 10px 12px;
            border: 1px solid rgba(11, 34, 57, 0.14);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 18px rgba(10, 30, 60, 0.08);
            font-weight: 900;
            color: var(--ink);
            min-width: 160px;
        }

        select:disabled {
            opacity: 0.6;
            box-shadow: none;
            background: rgba(255, 255, 255, 0.75);
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(20, 60, 110, 0.12);
            box-shadow: 0 16px 30px rgba(10, 30, 60, 0.16);
            padding: 10px 12px;
            border-radius: 14px;
            display: flex;
            gap: 10px;
            align-items: center;
            max-width: min(560px, calc(100% - 26px));
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 50;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-2px);
        }

        .toast .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: var(--brand2);
            box-shadow: 0 0 0 6px rgba(49, 196, 141, 0.18);
        }

        .toast .txt {
            font-size: 13px;
            color: var(--ink);
            font-weight: 900;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(8, 20, 35, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 18px;
        }

        .modal.show {
            display: flex;
        }

        .modalCard {
            width: min(560px, 100%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.22);
            padding: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            inset: -40px -40px auto -40px;
            height: 140px;
            background: radial-gradient(circle at 10% 50%,
                    rgba(26, 140, 255, 0.35),
                    transparent 35%),
                radial-gradient(circle at 35% 70%,
                    rgba(49, 196, 141, 0.35),
                    transparent 35%),
                radial-gradient(circle at 65% 40%,
                    rgba(255, 176, 32, 0.35),
                    transparent 35%),
                radial-gradient(circle at 85% 75%,
                    rgba(255, 77, 77, 0.28),
                    transparent 35%);
            opacity: 0.9;
        }

        .stars {
            font-size: 26px;
            margin: 6px 0 4px;
            letter-spacing: 2px;
        }

        .modalCard h2 {
            margin: 6px 0 8px;
            font-size: 18px;
        }

        .modalCard p {
            margin: 0 0 12px;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.4;
        }

        .modalActions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .loading {
            position: fixed;
            inset: 0;
            background: rgba(8, 20, 35, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 80;
            padding: 18px;
        }

        .loading.show {
            display: flex;
        }

        .loadingBox {
            width: min(420px, 100%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.65);
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.2);
            padding: 16px;
            text-align: center;
        }

        .spinner {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 4px solid rgba(11, 34, 57, 0.1);
            border-top-color: rgba(26, 140, 255, 0.65);
            margin: 6px auto 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 380px) {
            :root {
                --cell: 52px;
                --gap: 7px;
            }

            .keypad button {
                padding: 12px 8px;
            }

            select {
                min-width: 140px;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <div class="brand">
                <div class="headerButtons">
                    <div class="actionPause">
                        <button class="pause" id="btnPause" type="button">
                            <i class="ri-pause-large-fill"></i>
                        </button>
                        <span id="t_pause">Pause</span>
                    </div>
                    <div class="actionNew">
                        <button class="new" id="btnNew" type="button">
                            <i class="ri-reset-right-fill"></i>
                        </button>
                        <span id="t_new">New</span>
                    </div>
                </div>
                <div class="title">
                    <!-- <h1 id="t_app">Chlat Kids Sudoku</h1> -->
                    <!-- <p id="t_sub">Levels + Daily Challenge ‚Äî Khmer-first</p> -->
                </div>
            </div>

        </header>

        <div class="grid">
            <section class="card board-wrap">
                <div class="hud">
                    <div class="pill">
                        <span>üó∫Ô∏è</span><span id="t_mode">Mode</span><strong id="modeLabel">Free</strong>
                    </div>
                    <div class="pill">
                        <span>‚≠ê</span><span id="t_progress">Progress</span><strong id="progress">0/0</strong>
                    </div>
                    <div class="pill">
                        <span>üß†</span><span id="t_mistakes">Mistakes</span><strong id="mistakes">0</strong>
                    </div>
                    <div class="pill">
                        <span>üî•</span><span id="t_streak">Streak</span><strong id="streak">0</strong>
                    </div>
                </div>

                <div class="row" style="width: 100%; margin-bottom: 6px">
                    <div class="modeBar">
                        <button class="pillbtn active" id="btnFree" type="button">
                            <span>üåø</span> <span id="t_free">Free Levels</span>
                        </button>
                        <button class="pillbtn" id="btnDaily" type="button">
                            <span>üåû</span> <span id="t_daily">Daily Challenge</span>
                        </button>
                    </div>
                    <div class="modeBar">
                        <button class="pillbtn" id="btnSound" type="button">
                            <span>üîä</span> <span id="t_sound">Sound</span>
                        </button>
                        <div class="switch" role="tablist" aria-label="Language">
                            <button id="btnKM" class="active" type="button" role="tab" aria-selected="true">
                                ·ûÅ·üí·ûò·üÇ·ûö
                            </button>
                            <button id="btnEN" type="button" role="tab" aria-selected="false">
                                EN
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lvlBox" id="levelSelectBox">
                    <div class="lvlLeft">
                        <div class="lvlLabel" id="t_levelLabel">üéöÔ∏è Level</div>
                        <select id="levelSelect" aria-label="Select level"></select>
                        <button class="pillbtn" id="btnGoLevel" type="button">
                            ‚û°Ô∏è <span id="t_go">Go</span>
                        </button>
                    </div>
                    <div class="mini" id="levelInfo">Level 1 ‚Ä¢ 4√ó4 ‚Ä¢ Easy</div>
                </div>

                <div class="board" role="application" id="cells_container" aria-label="Sudoku board">

                    <div class="cells" id="cells"></div>
                </div>

                <!-- KEYPAD -->
                <div class="keypadBox">
                    <!-- LEFT SIDE -->
                    <div class="btn-hint-container">
                        <!-- hint -->
                        <button class="warn" id="btnHint" type="button">
                            <i class="ri-lightbulb-ai-line"></i>
                        </button>
                        <span id="t_hint">Hint</span>
                    </div>

                    <!-- RIGHT SIDE -->
                    <div class="right-panel">
                        <div class="keypad" id="keypad"></div>
                    </div>
                </div>

            </section>
        </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite">
        <div class="dot"></div>
        <div class="txt" id="toastText">Saved ‚úÖ</div>
    </div>

    <div class="modal" id="winModal" aria-hidden="true">
        <div class="modalCard" role="dialog" aria-modal="true" aria-label="Win">
            <div class="confetti" aria-hidden="true"></div>
            <div class="stars" id="winStars">üåüüåüüåü</div>
            <h2 id="winTitle">Great job! üéâ</h2>
            <p id="winText">You solved it.</p>
            <div class="modalActions">
                <button class="success" id="btnWinNext" type="button">
                    ‚û°Ô∏è <span id="t_next">Next</span>
                </button>
                <button id="btnWinClose" type="button">
                    üëç <span id="t_close">Close</span>
                </button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading" aria-hidden="true">
        <div class="loadingBox">
            <div class="spinner" aria-hidden="true"></div>
            <div style="font-weight: 900; margin-bottom: 6px" id="t_loading">
                Creating puzzle‚Ä¶
            </div>
            <div class="mini" id="t_loading2">Please wait a moment.</div>
        </div>
    </div>

    <script>
        (() => {
            const I18N = {
                km: {
                    app: "Chlat Kids Sudoku",
                    sub: "·ûÄ·ûò·üí·ûö·û∑·ûè + ·ûî·ûâ·üí·û†·û∂·ûî·üí·ûö·ûÖ·û∂·üÜ·ûê·üí·ûÑ·üÉ ‚Äî Khmer-first",
                    pause: "·ûï·üí·û¢·û∂·ûÄ",
                    reset: "·ûÄ·üÜ·ûé·ûè·üã·û°·ûæ·ûÑ·ûú·û∑·ûâ",
                    hint: "·ûá·ûΩ·ûô·ûî·ûì·üí·ûè·û∑·ûÖ",
                    new: "·ûõ·üí·ûî·üÇ·ûÑ·ûê·üí·ûò·û∏",
                    mode: "·ûö·ûî·üÄ·ûî",
                    free: "·ûÄ·ûò·üí·ûö·û∑·ûè·ûü·üÅ·ûö·û∏",
                    daily: "·ûî·üí·ûö·ûÖ·û∂·üÜ·ûê·üí·ûÑ·üÉ",
                    progress: "·ûÄ·û∂·ûö·ûö·û∏·ûÄ·ûÖ·ûò·üí·ûö·ûæ·ûì",
                    mistakes: "·ûÅ·ûª·ûü",
                    streak: "·ûü·üí·ûë·üí·ûö·û∏·ûÄ",
                    sound: "·ûü·ûò·üí·ûõ·üÅ·ûÑ",
                    level: "·ûÄ·ûò·üí·ûö·û∑·ûè",
                    go: "·ûë·üÖ",
                    tip: "·ûü·ûº·ûò·ûÖ·ûª·ûÖ·ûî·üí·ûö·û¢·ûî·üã·ûñ·ûé·üå·ûü ·ûö·ûΩ·ûÖ·ûá·üí·ûö·ûæ·ûü·ûõ·üÅ·ûÅ·üî ·ûî·üí·ûö·û¢·ûî·üã·ûî·üÉ·ûè·ûÑ ·ûÇ·û∫·ûê·üÅ·ûö·üî",
                    rules:
                        "·ûÖ·üí·ûî·û∂·ûî·üã·üñ ·ûá·ûΩ·ûö·ûä·üÅ·ûÄ/·ûá·ûΩ·ûö·ûà·ûö ·ûò·û∑·ûì·û¢·û∂·ûÖ·ûò·û∂·ûì·ûõ·üÅ·ûÅ·ûä·ûº·ûÖ·ûÇ·üí·ûì·û∂·üî ·ûî·üí·ûö·û¢·ûî·üã (Box) ·ûÄ·üè·ûä·ûº·ûÖ·ûÇ·üí·ûì·û∂·üî",
                    integration1: "·ûî·üí·ûö·ûæ·ûî·û∂·ûì·ûÄ·üí·ûö·üÖ·û¢·üä·û∏·ûì·ûí·û∫·ûé·û∑·ûè·üñ",
                    integration2: "WebView ·ûñ·üê·ûè·üå·ûò·û∂·ûì·üñ",
                    frogTitle: "·ûü·ûΩ·ûü·üí·ûè·û∏! ·ûÅ·üí·ûâ·ûª·üÜ·ûÇ·û∫ ‚Äú·ûÜ·üí·ûõ·û∂·ûè‚Äù üê∏",
                    frogBase: "·ûÄ·ûª·üÜ·û≤·üí·ûô·ûõ·üÅ·ûÅ·ûä·ûº·ûÖ·ûÇ·üí·ûì·û∂ ·ûì·üÖ·ûá·ûΩ·ûö·ûä·üÅ·ûÄ/·ûá·ûΩ·ûö·ûà·ûö/Box·üî ·û¢·üí·ûì·ûÄ·û¢·û∂·ûÖ·ûí·üí·ûú·ûæ·ûî·û∂·ûì!",
                    frogSelect: "·ûÖ·ûª·ûÖ·ûî·üí·ûö·û¢·ûî·üã·ûü·û∑·ûì ·ûë·ûæ·ûî·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûõ·üÅ·ûÅ·ûî·û∂·ûì·üî",
                    frogGood: "·ûõ·üí·û¢·ûé·û∂·ûü·üã! ·ûî·ûì·üí·ûè·ûë·üÖ·ûë·üÄ·ûè! üåü",
                    frogOops: "·û¢·ûº·û†·üç‚Ä¶ ·ûò·û∂·ûì·ûõ·üÅ·ûÅ·ûä·ûº·ûÖ·ûÇ·üí·ûì·û∂ üòÖ ·ûü·û∂·ûÄ·ûõ·üí·ûî·ûÑ·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè!",
                    frogHint: "·ûì·üÅ·üá·ûá·û∂·ûá·üÜ·ûì·ûΩ·ûô·ûè·ûº·ûÖ·üó üí°",
                    frogDaily: "·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûñ·û∑·ûü·üÅ·ûü! ·ûü·û∂·ûÄ·ûõ·üí·ûî·ûÑ·ûà·üí·ûì·üá·ûü·üí·ûë·üí·ûö·û∏·ûÄ üî•",
                    toastSaved: "·ûî·û∂·ûì·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ ‚úÖ",
                    toastReset: "·ûî·û∂·ûì·ûÄ·üÜ·ûé·ûè·üã·û°·ûæ·ûÑ·ûú·û∑·ûâ ‚Üª",
                    toastNew: "·ûî·û∂·ûì·ûÖ·û∂·ûî·üã·ûï·üí·ûè·ûæ·ûò·ûê·üí·ûò·û∏ ‚ú®",
                    toastHintNone: "·ûÇ·üí·ûò·û∂·ûì·ûÄ·ûì·üí·ûõ·üÇ·ûÑ·ûü·ûò·üí·ûö·û∂·ûî·üã·ûá·üÜ·ûì·ûΩ·ûô·ûë·üÅ üòÑ",
                    toastLocked: "·ûÄ·ûò·üí·ûö·û∑·ûè·ûì·üÅ·üá·ûì·üÖ·ûè·üÇ·ûÖ·û∂·ûÄ·üã·ûü·üÑ üîí",
                    toastDailyDone: "·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá·ûî·û∂·ûì·ûî·ûâ·üí·ûÖ·ûî·üã·ûö·ûΩ·ûÖ·û†·ûæ·ûô ‚úÖ",
                    winTitle: "·û¢·ûü·üí·ûÖ·û∂·ûö·üí·ûô! ·û¢·üí·ûì·ûÄ·ûà·üí·ûì·üá‡πÅ‡∏•‡πâ‡∏ß! üéâ",
                    winTextFree: "·û¢·üí·ûì·ûÄ·ûî·û∂·ûì·ûà·üí·ûì·üá·ûÄ·ûò·üí·ûö·û∑·ûè·ûì·üÅ·üá·üî ·ûÄ·ûò·üí·ûö·û∑·ûè·ûî·ûì·üí·ûë·û∂·ûî·üã·ûî·û∂·ûì·ûî·ûæ·ûÄ!",
                    winTextDaily: "·û¢·üí·ûì·ûÄ·ûî·û∂·ûì·ûà·üí·ûì·üá Daily Challenge! ·ûü·üí·ûë·üí·ûö·û∏·ûÄ·ûÄ·ûæ·ûì·û°·ûæ·ûÑ üî•",
                    close: "·ûî·û∑·ûë",
                    next: "·ûî·ûì·üí·ûë·û∂·ûî·üã",
                    today: "·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá",
                    erase: "·ûõ·ûª·ûî",
                    check: "·ûñ·û∑·ûì·û∑·ûè·üí·ûô",
                    loading: "·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûõ·üí·ûî·üÇ·ûÑ‚Ä¶",
                    loading2: "·ûü·ûº·ûò·ûö·ûÑ·üã·ûÖ·û∂·üÜ·ûî·ûì·üí·ûè·û∑·ûÖ·üî",
                    modeFreeLabel: "·ûü·üÅ·ûö·û∏",
                    modeDailyLabel: "·ûî·üí·ûö·ûÖ·û∂·üÜ·ûê·üí·ûÑ·üÉ",
                },
                en: {
                    app: "Chlat Kids Sudoku",
                    sub: "Levels + Daily Challenge ‚Äî Khmer-first UI",
                    pause: "Pause",
                    reset: "Reset",
                    hint: "Hint",
                    new: "New",
                    mode: "Mode",
                    free: "Free Levels",
                    daily: "Daily Challenge",
                    progress: "Progress",
                    mistakes: "Mistakes",
                    streak: "Streak",
                    sound: "Sound",
                    level: "Level",
                    go: "Go",
                    tip: "Tip: Tap a white box, then choose a number. Green boxes are fixed.",
                    rules: "Rules: No repeats in a row, column, or box.",
                    integration1: "Offline ready:",
                    integration2: "WebView tip:",
                    frogTitle: "Hi! I‚Äôm ‚ÄúChlat‚Äù üê∏",
                    frogBase: "No repeats in row/column/box. You can do it!",
                    frogSelect: "Tap a cell first.",
                    frogGood: "Nice! Keep going! üåü",
                    frogOops: "Oops‚Ä¶ duplicate number üòÖ Try again!",
                    frogHint: "Here‚Äôs a tiny hint üí°",
                    frogDaily: "Today is special! Win to keep your streak üî•",
                    toastSaved: "Saved ‚úÖ",
                    toastReset: "Reset ‚Üª",
                    toastNew: "New puzzle ‚ú®",
                    toastHintNone: "No hint spot üòÑ",
                    toastLocked: "That level is locked üîí",
                    toastDailyDone: "Already completed today ‚úÖ",
                    winTitle: "Great job! You win! üéâ",
                    winTextFree: "You cleared the level. Next level unlocked!",
                    winTextDaily: "You beat the Daily Challenge! Streak increased üî•",
                    close: "Close",
                    next: "Next",
                    today: "Today",
                    erase: "Erase",
                    check: "Check",
                    loading: "Creating puzzle‚Ä¶",
                    loading2: "Please wait a moment.",
                    modeFreeLabel: "Free",
                    modeDailyLabel: "Daily",
                },
            };

            // Sound
            const Sound = (() => {
                let enabled = true;
                let ctx = null;
                function beep(
                    freq = 520,
                    duration = 0.08,
                    type = "sine",
                    gain = 0.05
                ) {
                    if (!enabled) return;
                    try {
                        ctx =
                            ctx || new (window.AudioContext || window.webkitAudioContext)();
                        const o = ctx.createOscillator();
                        const g = ctx.createGain();
                        o.type = type;
                        o.frequency.value = freq;
                        g.gain.value = gain;
                        o.connect(g);
                        g.connect(ctx.destination);
                        o.start();
                        o.stop(ctx.currentTime + duration);
                    } catch (e) { }
                }
                function good() {
                    beep(660, 0.08, "triangle", 0.06);
                    setTimeout(() => beep(880, 0.09, "triangle", 0.05), 90);
                }
                function bad() {
                    beep(180, 0.1, "sawtooth", 0.05);
                }
                function tap() {
                    beep(520, 0.05, "sine", 0.03);
                }
                return {
                    toggle() {
                        enabled = !enabled;
                        return enabled;
                    },
                    get enabled() {
                        return enabled;
                    },
                    tap,
                    good,
                    bad,
                };
            })();

            // RNG helpers
            function mulberry32(seed) {
                let t = seed >>> 0;
                return function () {
                    t += 0x6d2b79f5;
                    let x = t;
                    x = Math.imul(x ^ (x >>> 15), x | 1);
                    x ^= x + Math.imul(x ^ (x >>> 7), x | 61);
                    return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
                };
            }
            function hashStringToSeed(str) {
                let h = 2166136261 >>> 0;
                for (let i = 0; i < str.length; i++) {
                    h ^= str.charCodeAt(i);
                    h = Math.imul(h, 16777619);
                }
                return h >>> 0;
            }
            function shuffle(arr, rnd = Math.random) {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(rnd() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

            // Sudoku engine (4/6/9)
            const ENGINE = {
                config(size) {
                    if (size === 4)
                        return { N: 4, boxR: 2, boxC: 2, symbols: [1, 2, 3, 4] };
                    if (size === 6)
                        return { N: 6, boxR: 2, boxC: 3, symbols: [1, 2, 3, 4, 5, 6] };
                    return {
                        N: 9,
                        boxR: 3,
                        boxC: 3,
                        symbols: [1, 2, 3, 4, 5, 6, 7, 8, 9],
                    };
                },
                emptyGrid(N) {
                    return Array.from({ length: N }, () => Array(N).fill(0));
                },
                canPlace(grid, r, c, val, cfg) {
                    const { N, boxR, boxC } = cfg;
                    for (let i = 0; i < N; i++) {
                        if (grid[r][i] === val) return false;
                        if (grid[i][c] === val) return false;
                    }
                    const br = Math.floor(r / boxR) * boxR;
                    const bc = Math.floor(c / boxC) * boxC;
                    for (let rr = br; rr < br + boxR; rr++) {
                        for (let cc = bc; cc < bc + boxC; cc++) {
                            if (grid[rr][cc] === val) return false;
                        }
                    }
                    return true;
                },
                findBestCell(grid, cfg) {
                    const { N, symbols } = cfg;
                    let best = null;
                    for (let r = 0; r < N; r++) {
                        for (let c = 0; c < N; c++) {
                            if (grid[r][c] !== 0) continue;
                            const cand = [];
                            for (const v of symbols) {
                                if (this.canPlace(grid, r, c, v, cfg)) cand.push(v);
                            }
                            if (cand.length === 0) return { r, c, candidates: [] };
                            if (!best || cand.length < best.candidates.length) {
                                best = { r, c, candidates: cand };
                                if (cand.length === 1) return best;
                            }
                        }
                    }
                    return best;
                },
                solve(grid, cfg, rnd = Math.random) {
                    const pick = this.findBestCell(grid, cfg);
                    if (!pick) return true;
                    const { r, c, candidates } = pick;
                    if (candidates.length === 0) return false;
                    const order = shuffle(candidates.slice(), rnd);
                    for (const v of order) {
                        grid[r][c] = v;
                        if (this.solve(grid, cfg, rnd)) return true;
                        grid[r][c] = 0;
                    }
                    return false;
                },
                countSolutions(grid, cfg, limit = 2) {
                    let count = 0;
                    const dfs = () => {
                        if (count >= limit) return;
                        const pick = this.findBestCell(grid, cfg);
                        if (!pick) {
                            count++;
                            return;
                        }
                        const { r, c, candidates } = pick;
                        if (candidates.length === 0) return;
                        for (const v of candidates) {
                            grid[r][c] = v;
                            dfs();
                            grid[r][c] = 0;
                            if (count >= limit) return;
                        }
                    };
                    dfs();
                    return count;
                },
                makeSolution(cfg, rnd = Math.random) {
                    const g = this.emptyGrid(cfg.N);
                    this.solve(g, cfg, rnd);
                    return g;
                },
                clone(grid) {
                    return grid.map((r) => r.slice());
                },
                makePuzzleFromSolution(
                    solution,
                    cfg,
                    givensTarget,
                    uniqueness = true,
                    rnd = Math.random
                ) {
                    const N = cfg.N;
                    const puzzle = this.clone(solution);
                    const pos = [];
                    for (let r = 0; r < N; r++)
                        for (let c = 0; c < N; c++) pos.push([r, c]);
                    shuffle(pos, rnd);
                    let toRemove = Math.max(0, N * N - givensTarget);

                    let attempts = 0;
                    const maxAttempts = N * N * 7;
                    for (
                        let i = 0;
                        i < pos.length && toRemove > 0 && attempts < maxAttempts;
                        i++
                    ) {
                        attempts++;
                        const [r, c] = pos[i];
                        const backup = puzzle[r][c];
                        if (backup === 0) continue;
                        puzzle[r][c] = 0;

                        if (uniqueness) {
                            const test = this.clone(puzzle);
                            const cnt = this.countSolutions(test, cfg, 2);
                            if (cnt !== 1) {
                                puzzle[r][c] = backup;
                                continue;
                            }
                        } else {
                            const test = this.clone(puzzle);
                            const ok = this.solve(test, cfg, rnd);
                            if (!ok) {
                                puzzle[r][c] = backup;
                                continue;
                            }
                        }
                        toRemove--;
                    }
                    return puzzle;
                },
                conflicts(grid, cfg) {
                    const N = cfg.N;
                    const out = Array.from({ length: N }, () => Array(N).fill(false));
                    for (let r = 0; r < N; r++) {
                        for (let c = 0; c < N; c++) {
                            const v = grid[r][c];
                            if (v === 0) continue;
                            grid[r][c] = 0;
                            const ok = this.canPlace(grid, r, c, v, cfg);
                            grid[r][c] = v;
                            if (!ok) out[r][c] = true;
                        }
                    }
                    return out;
                },
                isSolved(grid, solution, cfg) {
                    for (let r = 0; r < cfg.N; r++) {
                        for (let c = 0; c < cfg.N; c++) {
                            if (grid[r][c] !== solution[r][c]) return false;
                        }
                    }
                    return true;
                },
            };

            // Levels
            function levelToSpec(level) {
                if (level <= 30) {
                    const givens = Math.max(8, 12 - Math.floor((level - 1) / 5));
                    return { size: 4, label: "4√ó4", givens, uniqueness: true };
                }
                if (level <= 70) {
                    const step = level - 31;
                    const givens = Math.max(16, 22 - Math.floor(step / 6));
                    return { size: 6, label: "6√ó6", givens, uniqueness: true };
                }
                const step = level - 71;
                const givens = Math.max(28, 36 - Math.floor(step / 5));
                return { size: 9, label: "9√ó9", givens, uniqueness: true };
            }

            // Storage
            const STORE_KEY = "chlat_sudoku_allinone_v2";
            const STREAK_KEY = "chlat_sudoku_daily_streak_v2";
            const $ = (q) => document.querySelector(q);
            function loadStore() {
                try {
                    const r = localStorage.getItem(STORE_KEY);
                    return r ? JSON.parse(r) : null;
                } catch (e) {
                    return null;
                }
            }
            function saveStore(o) {
                try {
                    localStorage.setItem(STORE_KEY, JSON.stringify(o));
                } catch (e) { }
            }
            function todayKey() {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
                    2,
                    "0"
                )}-${String(d.getDate()).padStart(2, "0")}`;
            }
            function loadStreak() {
                try {
                    const r = localStorage.getItem(STREAK_KEY);
                    return r
                        ? JSON.parse(r)
                        : { streak: 0, lastDay: null, completedDay: null };
                } catch (e) {
                    return { streak: 0, lastDay: null, completedDay: null };
                }
            }
            function saveStreak(o) {
                try {
                    localStorage.setItem(STREAK_KEY, JSON.stringify(o));
                } catch (e) { }
            }

            const el = {
                // t_app: $("#t_app"),
                t_pause: $("#t_pause"),
                // t_reset: $("#t_reset"),
                t_hint: $("#t_hint"),
                t_new: $("#t_new"),
                t_mode: $("#t_mode"),
                t_free: $("#t_free"),
                t_daily: $("#t_daily"),
                t_progress: $("#t_progress"),
                t_mistakes: $("#t_mistakes"),
                t_streak: $("#t_streak"),
                t_sound: $("#t_sound"),
                t_levelLabel: $("#t_levelLabel"),
                t_go: $("#t_go"),
                t_next: $("#t_next"),
                t_close: $("#t_close"),
                t_loading: $("#t_loading"),
                t_loading2: $("#t_loading2"),
                modeLabel: $("#modeLabel"),
                progress: $("#progress"),
                mistakes: $("#mistakes"),
                streak: $("#streak"),
                cells: $("#cells"),
                keypad: $("#keypad"),
                levelInfo: $("#levelInfo"),
                levelSelectBox: $("#levelSelectBox"),
                levelSelect: $("#levelSelect"),
                btnGoLevel: $("#btnGoLevel"),
                tip: $("#tip"),
                rules: $("#rules"),
                integration: $("#integration"),
                frogEmoji: $("#frogEmoji"),
                frogTitle: $("#frogTitle"),
                frogText: $("#frogText"),

                btnPause: $("#btnPause"),
                // btnReset: $("#btnReset"),
                btnHint: $("#btnHint"),
                btnNew: $("#btnNew"),
                btnFree: $("#btnFree"),
                btnDaily: $("#btnDaily"),
                btnSound: $("#btnSound"),
                btnKM: $("#btnKM"),
                btnEN: $("#btnEN"),
                toast: $("#toast"),
                toastText: $("#toastText"),
                winModal: $("#winModal"),
                winStars: $("#winStars"),
                winTitle: $("#winTitle"),
                winText: $("#winText"),
                btnWinNext: $("#btnWinNext"),
                btnWinClose: $("#btnWinClose"),
                loading: $("#loading"),
            };

            // State
            let lang = "km";
            let mode = "free"; // free | daily
            let level = 1;

            let cfg = ENGINE.config(4);
            let solution = null;
            let puzzle = null;
            let grid = null;

            // IMPORTANT: fixed naming (no shadowing)
            let givensMask = null;

            let selected = { r: -1, c: -1 };
            let mistakes = 0;
            let lastSelectedVal = 0;

            function toast(msg) {
                el.toastText.textContent = msg;
                el.toast.classList.add("show");
                clearTimeout(toast._t);
                toast._t = setTimeout(() => el.toast.classList.remove("show"), 1200);
            }
            function showLoading(on) {
                el.loading.classList.toggle("show", !!on);
                el.loading.setAttribute("aria-hidden", on ? "false" : "true");
            }
            function setCellSizeFor(N) {
                let cell = 56;
                if (N === 4) cell = 64;
                if (N === 6) cell = 56;
                if (N === 9) cell = 40;
                if (window.innerWidth < 380) {
                    if (N === 9) cell = 36;
                    if (N === 6) cell = 52;
                    if (N === 4) cell = 60;
                }
                document.documentElement.style.setProperty("--cell", `${cell}px`);
                document.documentElement.style.setProperty(
                    "--gap",
                    N === 9 ? "6px" : "8px"
                );
            }

            function frogSay(kind) {
                const T = I18N[lang];
                if (kind === "good") {
                    // el.frogEmoji.textContent = "üê∏";
                    // el.frogText.textContent = T.frogGood;
                } else if (kind === "oops") {
                    // el.frogEmoji.textContent = "üòÖ";
                    // el.frogText.textContent = T.frogOops;
                } else if (kind === "select") {
                    el.frogEmoji.textContent = "üëâ";
                    el.frogText.textContent = T.frogSelect;
                } else if (kind === "hint") {
                    el.frogEmoji.textContent = "üí°";
                    el.frogText.textContent = T.frogHint;
                } else if (kind === "daily") {
                    el.frogEmoji.textContent = "üåû";
                    el.frogText.textContent = T.frogDaily;
                } else {
                    // el.frogEmoji.textContent = "üê∏";
                    // el.frogText.textContent = T.frogBase;
                }
            }

            function applyLang() {
                const T = I18N[lang];
                // el.t_app.textContent = T.app;
                el.t_pause.textContent = T.pause;
                // el.t_reset.textContent = T.reset;
                el.t_hint.textContent = T.hint;
                el.t_new.textContent = T.new;
                el.t_mode.textContent = T.mode;
                el.t_free.textContent = T.free;
                el.t_daily.textContent = T.daily;
                el.t_progress.textContent = T.progress;
                el.t_mistakes.textContent = T.mistakes;
                el.t_streak.textContent = T.streak;
                el.t_sound.textContent = T.sound;
                el.t_levelLabel.textContent = "üéöÔ∏è " + T.level;
                el.t_go.textContent = T.go;
                // el.tip.textContent = T.tip;
                // el.rules.textContent = T.rules;
                // el.integration.innerHTML = `<b>${T.integration1}</b> Single-file HTML. Uses <code>localStorage</code>.<br><br><b>${T.integration2}</b> Load as local asset in WebView.`;
                el.t_close.textContent = T.close;
                el.t_next.textContent = T.next;
                el.t_loading.textContent = T.loading;
                el.t_loading2.textContent = T.loading2;
                // el.frogTitle.textContent = T.frogTitle;

                el.btnKM.classList.toggle("active", lang === "km");
                el.btnEN.classList.toggle("active", lang === "en");
                el.modeLabel.textContent =
                    mode === "free" ? T.modeFreeLabel : T.modeDailyLabel;
                el.btnSound.innerHTML =
                    (Sound.enabled ? "üîä " : "üîá ") + `<span>${T.sound}</span>`;

                el.levelSelect.disabled = mode !== "free";
                el.btnGoLevel.disabled = mode !== "free";
                el.levelSelectBox.style.opacity = mode !== "free" ? "0.6" : "1";
            }

            function computeProgress() {
                const N = cfg.N;
                let filled = 0;
                for (let r = 0; r < N; r++)
                    for (let c = 0; c < N; c++) if (grid[r][c] !== 0) filled++;
                return `${filled}/${N * N}`;
            }
            function updateHUD() {
                el.progress.textContent = grid ? computeProgress() : "0/0";
                el.mistakes.textContent = String(mistakes);
                el.streak.textContent = String(loadStreak().streak || 0);
                el.modeLabel.textContent =
                    mode === "free"
                        ? I18N[lang].modeFreeLabel
                        : I18N[lang].modeDailyLabel;
            }

            function buildKeypad() {
                const N = cfg.N;
                el.keypad.innerHTML = "";
                el.keypad.style.gridTemplateColumns = `repeat(3, 1fr) `;
                for (let i = 1; i <= N; i++) {
                    const b = document.createElement("button");
                    b.className = "primary";
                    b.textContent = String(i);
                    b.addEventListener("click", () => setValue(i));
                    el.keypad.appendChild(b);
                }
                const bErase = document.createElement("button");
                bErase.className = "small";
                bErase.innerHTML = `‚å´ <span>${I18N[lang].erase}</span>`;
                bErase.addEventListener("click", eraseValue);

                // const bCheck = document.createElement("button");
                // bCheck.className = "small";
                // bCheck.innerHTML = `‚úÖ <span>${I18N[lang].check}</span>`;
                // bCheck.addEventListener("click", checkBoard);

                el.keypad.appendChild(bErase);
                // el.keypad.appendChild(bCheck);
            }

            function getUnlockedLevel() {
                const store = loadStore();
                return store?.free?.unlockedLevel || 1;
            }
            function setUnlockedLevel(val) {
                const store = loadStore() || {};
                store.free = store.free || {};
                store.free.unlockedLevel = Math.max(
                    store.free.unlockedLevel || 1,
                    val
                );
                saveStore(store);
            }

            function buildLevelSelect() {
                const unlocked = getUnlockedLevel();
                el.levelSelect.innerHTML = "";
                for (let i = 1; i <= 100; i++) {
                    const spec = levelToSpec(i);
                    const opt = document.createElement("option");
                    opt.value = String(i);
                    const lock = i > unlocked;
                    opt.textContent = lock
                        ? `üîí Level ${i} (${spec.label})`
                        : `üçÉ Level ${i} (${spec.label})`;
                    opt.disabled = lock;
                    el.levelSelect.appendChild(opt);
                }
                el.levelSelect.value = String(Math.min(level, unlocked));
            }

            function buildBoard() {
                if (!grid || !givensMask) return; // safety
                const N = cfg.N;
                setCellSizeFor(N);
                el.cells.innerHTML = "";
                el.cells.style.gridTemplateColumns = `repeat(${N}, var(--cell))`;

                const conflicts = ENGINE.conflicts(grid, cfg);

                for (let r = 0; r < N; r++) {
                    for (let c = 0; c < N; c++) {
                        const d = document.createElement("div");
                        d.className = "cell";
                        d.dataset.r = r;
                        d.dataset.c = c;

                        const atBoxRight = (c + 1) % cfg.boxC === 0 && c !== N - 1;
                        const atBoxBottom = (r + 1) % cfg.boxR === 0 && r !== N - 1;
                        if (atBoxRight) {
                            d.style.borderRight = "4px solid black";
                        }
                        if (atBoxBottom){
                            d.style.borderBottom = "4px solid black";
                        }

                        if (givensMask[r][c]) d.classList.add("given");
                        const v = grid[r][c];
                        d.textContent = v === 0 ? "" : String(v);
                        if (conflicts[r][c]) d.classList.add("conflict");

                        d.addEventListener("click", () => {
                            if (givensMask[r][c]) {
                                Sound.tap();
                                return;
                            }
                            selectCell(r, c);
                            Sound.tap();
                        });

                        el.cells.appendChild(d);
                    }
                }

                //const cells = N * N;
                // const container = document.getElementById('cells_container');
                // const cells = document.querySelectorAll('#cells .cell.given');
                // cells[1].style.setProperty('--line-h', `${container.clientHeight}px`);
                // cells[1].classList.add('divider-line')
                renderSelectionHighlights();
            }

            function getCellEl(r, c) {
                return el.cells.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
            }
            function selectCell(r, c) {
                selected = { r, c };
                lastSelectedVal = grid[r][c] || 0;
                renderSelectionHighlights();
            }
            function clearSelection() {
                selected = { r: -1, c: -1 };
                lastSelectedVal = 0;
                renderSelectionHighlights();
            }
            function renderSelectionHighlights() {
                if (!grid) return;
                const N = cfg.N;
                const conflicts = ENGINE.conflicts(grid, cfg);
                for (let r = 0; r < N; r++) {
                    for (let c = 0; c < N; c++) {
                        const node = getCellEl(r, c);
                        if (!node) continue;
                        node.classList.toggle(
                            "selected",
                            selected.r === r && selected.c === c
                        );
                        node.classList.toggle("conflict", conflicts[r][c]);
                        const v = grid[r][c];
                        node.textContent = v === 0 ? "" : String(v);
                        const same = lastSelectedVal !== 0 && v === lastSelectedVal;
                        node.classList.toggle(
                            "same",
                            same &&
                            !(selected.r === r && selected.c === c) &&
                            !node.classList.contains("given")
                        );
                    }
                }
            }

            function setValue(val) {
                if (selected.r < 0) {
                    frogSay("select");
                    Sound.bad();
                    return;
                }
                const { r, c } = selected;
                if (givensMask[r][c]) return;

                grid[r][c] = val;
                lastSelectedVal = val;

                const conflicts = ENGINE.conflicts(grid, cfg);
                if (conflicts[r][c]) {
                    mistakes++;
                    frogSay("oops");
                    Sound.bad();
                } else {
                    frogSay("good");
                    Sound.good();
                }

                renderSelectionHighlights();
                updateHUD();
                persist();

                if (ENGINE.isSolved(grid, solution, cfg)) onWin();
            }

            function eraseValue() {
                if (selected.r < 0) {
                    frogSay("select");
                    Sound.bad();
                    return;
                }
                const { r, c } = selected;
                if (givensMask[r][c]) return;
                grid[r][c] = 0;
                lastSelectedVal = 0;
                Sound.tap();
                frogSay();
                renderSelectionHighlights();
                updateHUD();
                persist();
            }

            function checkBoard() {
                const conflicts = ENGINE.conflicts(grid, cfg);
                let any = false;
                for (let r = 0; r < cfg.N; r++)
                    for (let c = 0; c < cfg.N; c++) if (conflicts[r][c]) any = true;
                if (any) {
                    mistakes++;
                    frogSay("oops");
                    Sound.bad();
                } else {
                    frogSay("good");
                    Sound.good();
                }
                renderSelectionHighlights();
                updateHUD();
                persist();
            }

            function hint() {
                const empties = [];
                for (let r = 0; r < cfg.N; r++) {
                    for (let c = 0; c < cfg.N; c++) {
                        if (givensMask[r][c]) continue;
                        if (grid[r][c] === 0) empties.push([r, c]);
                    }
                }
                if (!empties.length) {
                    toast(I18N[lang].toastHintNone);
                    Sound.tap();
                    return;
                }
                const [r, c] = empties[Math.floor(Math.random() * empties.length)];
                grid[r][c] = solution[r][c];
                const node = getCellEl(r, c);
                if (node) node.classList.add("hint");
                setTimeout(() => node && node.classList.remove("hint"), 700);

                frogSay("hint");
                Sound.tap();
                selectCell(r, c);
                renderSelectionHighlights();
                updateHUD();
                persist();

                if (ENGINE.isSolved(grid, solution, cfg)) onWin();
            }

            function setLevel(newLevel) {
                const unlocked = getUnlockedLevel();
                const target = Math.min(100, Math.max(1, newLevel));
                if (target > unlocked) {
                    toast(I18N[lang].toastLocked);
                    Sound.bad();
                    el.levelSelect.value = String(unlocked);
                    return;
                }
                level = target;
                const spec = levelToSpec(level);
                el.levelInfo.textContent = `Level ${level} ‚Ä¢ ${spec.label} ‚Ä¢ givens ${spec.givens}`;
                generateAndStartPuzzle({
                    size: spec.size,
                    givensTarget: spec.givens,
                    uniqueness: spec.uniqueness,
                    seed: null,
                });
                el.levelSelect.value = String(level);
                persist();
            }

            function switchMode(newMode) {
                mode = newMode;
                el.btnFree.classList.toggle("active", mode === "free");
                el.btnDaily.classList.toggle("active", mode === "daily");
                applyLang();

                if (mode === "daily") {
                    frogSay("daily");
                    startDaily();
                } else {
                    frogSay();
                    buildLevelSelect();
                    const store = loadStore();
                    const last = store?.free?.currentLevel || 1;
                    setLevel(last);
                }
                updateHUD();
                persist();
            }

            function startDaily() {
                const s = loadStreak();
                const tk = todayKey();
                const alreadyDone = s.completedDay === tk;

                const streakVal = s.streak || 0;
                let size = 4;
                if (streakVal >= 3) size = 6;
                if (streakVal >= 7) size = 9;

                const givensTarget = size === 4 ? 10 : size === 6 ? 20 : 34;
                const seed = hashStringToSeed("chlat-daily-" + tk + "-size" + size);

                el.levelInfo.textContent = `${I18N[lang].today} ‚Ä¢ ${size}√ó${size} ‚Ä¢ Daily`;
                generateAndStartPuzzle({
                    size,
                    givensTarget,
                    uniqueness: true,
                    seed,
                });

                if (alreadyDone) toast(I18N[lang].toastDailyDone);
            }

            // ‚úÖ FIXED: NO SHADOWING, ALWAYS CREATES grid + givensMask BEFORE rendering
            function generateAndStartPuzzle({
                size,
                givensTarget,
                uniqueness,
                seed,
            }) {
                showLoading(true);

                setTimeout(() => {
                    cfg = ENGINE.config(size);
                    mistakes = 0;
                    selected = { r: -1, c: -1 };
                    lastSelectedVal = 0;

                    const rnd = seed != null ? mulberry32(seed) : Math.random;

                    let sol = null;
                    const maxTries = size === 9 ? 6 : 4;

                    for (let t = 0; t < maxTries; t++) {
                        const s = ENGINE.makeSolution(cfg, rnd);
                        const puz = ENGINE.makePuzzleFromSolution(
                            s,
                            cfg,
                            givensTarget,
                            uniqueness,
                            rnd
                        );
                        const test = ENGINE.clone(puz);
                        const ok = ENGINE.solve(test, cfg, rnd);
                        if (ok) {
                            sol = s;
                            puzzle = puz;
                            break;
                        }
                    }
                    if (!sol) {
                        sol = ENGINE.makeSolution(cfg, rnd);
                        puzzle = ENGINE.makePuzzleFromSolution(
                            sol,
                            cfg,
                            givensTarget,
                            false,
                            rnd
                        );
                    }

                    solution = sol;
                    grid = ENGINE.clone(puzzle);
                    givensMask = puzzle.map((row) => row.map((v) => v !== 0)); // ‚úÖ global mask

                    applyLang();
                    buildKeypad();
                    buildBoard(); // ‚úÖ now always has grid + givensMask
                    updateHUD();
                    persist();

                    showLoading(false);
                }, 40);
            }

            function computeStars() {
                if (mistakes === 0) return 3;
                if (mistakes <= 2) return 2;
                return 1;
            }

            function onWin() {
                const T = I18N[lang];
                el.winStars.textContent = "üåü".repeat(computeStars());
                el.winTitle.textContent = T.winTitle;

                if (mode === "free") {
                    el.winText.textContent = T.winTextFree;
                    const unlocked = getUnlockedLevel();
                    if (level >= unlocked) setUnlockedLevel(Math.min(100, level + 1));
                    buildLevelSelect();
                    el.levelSelect.value = String(level);
                } else {
                    el.winText.textContent = T.winTextDaily;
                    const tk = todayKey();
                    const s = loadStreak();
                    if (s.completedDay !== tk) {
                        const d = new Date();
                        const y = new Date(d);
                        y.setDate(d.getDate() - 1);
                        const yk = `${y.getFullYear()}-${String(
                            y.getMonth() + 1
                        ).padStart(2, "0")}-${String(y.getDate()).padStart(2, "0")}`;
                        s.streak = s.lastDay === yk ? (s.streak || 0) + 1 : 1;
                        s.lastDay = tk;
                        s.completedDay = tk;
                        saveStreak(s);
                    }
                }

                el.winModal.classList.add("show");
                el.winModal.setAttribute("aria-hidden", "false");
                Sound.good();
                updateHUD();
                persist();
            }

            function closeWin() {
                el.winModal.classList.remove("show");
                el.winModal.setAttribute("aria-hidden", "true");
                frogSay("good");
            }
            function goNextAfterWin() {
                closeWin();
                if (mode === "free") {
                    const unlocked = getUnlockedLevel();
                    const next = Math.min(100, level + 1);
                    if (next <= unlocked) setLevel(next);
                    else setLevel(level);
                } else {
                    startDaily();
                }
            }

            function resetPuzzle() {
                grid = ENGINE.clone(puzzle);
                mistakes = 0;
                selected = { r: -1, c: -1 };
                lastSelectedVal = 0;
                frogSay();
                buildBoard();
                updateHUD();
                persist();
                toast(I18N[lang].toastReset);
            }

            let paused = false;
            function handlePause() {
                paused = !paused;

                // Disable interactions
                el.cells.classList.toggle("paused", paused);
                el.keypad.classList.toggle("paused", paused);

                // Update button icon + text
                el.btnPause.innerHTML = paused
                    ? `<i class="ri-play-large-fill"></i> <span>${I18N[lang].go}</span>`
                    : `<i class="ri-pause-large-fill"></i> <span>${I18N[lang].pause}</span>`;

                frogSay(paused ? "select" : null);
                Sound.tap();
            }


            function newPuzzle() {
                console.log("New Game...");
                if (mode === "daily") {
                    startDaily();
                    toast(I18N[lang].toastNew);
                    return;
                }
                const spec = levelToSpec(level);
                generateAndStartPuzzle({
                    size: spec.size,
                    givensTarget: spec.givens,
                    uniqueness: spec.uniqueness,
                    seed: null,
                });
                toast(I18N[lang].toastNew);
            }

            function persist() {
                const store = loadStore() || {};
                store.lang = lang;
                store.sound = Sound.enabled;
                store.mode = mode;
                store.free = store.free || {};
                store.free.currentLevel = level;
                store.session = {
                    mode,
                    level,
                    cfgN: cfg.N,
                    solution,
                    puzzle,
                    grid,
                    givensMask,
                    mistakes,
                    dateKey: todayKey(),
                };
                saveStore(store);
                toast(I18N[lang].toastSaved);
            }

            function restore() {
                const store = loadStore();
                if (!store) return false;

                lang = store.lang || "km";
                if (typeof store.sound === "boolean" && store.sound !== Sound.enabled)
                    Sound.toggle();
                mode = store.mode || "free";
                level = store.free?.currentLevel || 1;

                const s = store.session;
                if (s && s.solution && s.puzzle && s.grid) {
                    cfg = ENGINE.config(s.cfgN || 4);
                    solution = s.solution;
                    puzzle = s.puzzle;
                    grid = s.grid;
                    givensMask =
                        s.givensMask || puzzle.map((row) => row.map((v) => v !== 0));
                    mistakes = s.mistakes || 0;

                    if (s.mode === "daily" && s.dateKey !== todayKey()) return false;
                    return true;
                }
                return false;
            }

            // Events
            // el.btnReset.addEventListener("click", resetPuzzle);
            el.btnPause.addEventListener("click", handlePause);
            el.btnHint.addEventListener("click", hint);
            el.btnNew.addEventListener("click", newPuzzle);

            el.btnFree.addEventListener("click", () => switchMode("free"));
            el.btnDaily.addEventListener("click", () => switchMode("daily"));

            el.btnKM.addEventListener("click", () => {
                lang = "km";
                applyLang();
                buildKeypad();
                buildLevelSelect();
                persist();
            });
            el.btnEN.addEventListener("click", () => {
                lang = "en";
                applyLang();
                buildKeypad();
                buildLevelSelect();
                persist();
            });

            el.btnSound.addEventListener("click", () => {
                const on = Sound.toggle();
                el.btnSound.innerHTML =
                    (on ? "üîä " : "üîá ") + `<span>${I18N[lang].sound}</span>`;
                persist();
            });

            el.btnGoLevel.addEventListener("click", () => {
                if (mode !== "free") return;
                const target = parseInt(el.levelSelect.value, 10);
                setLevel(target);
            });

            el.btnWinClose.addEventListener("click", closeWin);
            el.btnWinNext.addEventListener("click", goNextAfterWin);
            el.winModal.addEventListener("click", (e) => {
                if (e.target === el.winModal) closeWin();
            });

            document.addEventListener("click", (e) => {
                const insideCell = e.target.closest && e.target.closest(".cell");
                const insideKeypad = e.target.closest && e.target.closest("#keypad");
                if (!insideCell && !insideKeypad) clearSelection();
            });

            window.addEventListener("keydown", (e) => {
                if (el.winModal.classList.contains("show")) {
                    if (e.key === "Escape") closeWin();
                    return;
                }
                if (e.key >= "1" && e.key <= "9") {
                    const v = parseInt(e.key, 10);
                    if (v <= cfg.N) setValue(v);
                }
                if (e.key === "Backspace" || e.key === "Delete") eraseValue();
                if (e.key === "Enter") checkBoard();
                if (e.key === "h" || e.key === "H") hint();
            });

            // Init
            function init() {
                el.streak.textContent = String(loadStreak().streak || 0);
                const resumed = restore();
                applyLang();
                el.btnSound.innerHTML =
                    (Sound.enabled ? "üîä " : "üîá ") +
                    `<span>${I18N[lang].sound}</span>`;

                buildLevelSelect();

                if (resumed) {
                    buildKeypad();
                    buildBoard();
                    el.levelSelect.value = String(level);
                    updateHUD();
                    frogSay(mode === "daily" ? "daily" : null);
                    return;
                }

                if (mode === "daily") switchMode("daily");
                else switchMode("free");
            }

            init();
        })();
    </script>
</body>

</html>